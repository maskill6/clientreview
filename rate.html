<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rate Employees</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .employee-rating {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }
    .employee-name { font-weight: bold; font-size: 1.1rem; margin-right: 1rem; }
    .stars { display: inline-flex; flex-direction: row-reverse; justify-content: flex-end; gap: 4px; }
    .stars input[type="radio"] { display: none; }
    .stars label { font-size: 1.5rem; color: lightgray; cursor: pointer; transition: color 0.2s; }
    .stars input:checked ~ label, .stars label:hover, .stars label:hover ~ label { color: gold; }
    .feedback-section, .rehire-section { margin-top: 0.75rem; }
    fieldset { border: 1px solid #ccc; border-radius: 6px; padding: 0.75rem 1rem; margin-bottom: 1rem; }
    legend { padding: 0 0.5rem; }
    textarea, select { width: 100%; padding: 0.5rem; margin-top: 0.25rem; }
    button { margin-top: 1rem; }
    .note { color: #666; font-size: .9rem; margin-bottom: .75rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Rate Each Employee</h1>
    <p class="note">Job: <span id="jobId"></span></p>

    <form id="ratingForm"></form>
    <button type="button" id="submitRatings">Submit Ratings</button>

    <div id="status" class="note" aria-live="polite" style="margin-top:.75rem;"></div>
  </div>

  <script>
    // ðŸ”§ PUT YOUR APPS SCRIPT /exec URL HERE:
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyDloMh7_zYLDzrxE2_Zx0O1xYYOTZZLZBufuzTR5U/dev';

    const form = document.getElementById('ratingForm');
    const statusEl = document.getElementById('status');

    // Use ?job=LL-2025-0142
    const params = new URLSearchParams(window.location.search);
    const jobId = params.get('job') || '';
    document.getElementById('jobId').textContent = jobId || '(missing)';

    // Load employees saved by the generator (index.html)
    const saved = (localStorage.getItem('last_emps_' + jobId) || '').split('\n').filter(Boolean);

    if (!jobId) {
      form.innerHTML = `<p style="color:red;">Missing job id. This page must be opened from a generated link like <code>rate.html?job=LL-2025-0142</code>.</p>`;
      document.getElementById('submitRatings').disabled = true;
      throw new Error('Missing job id');
    }

    if (!saved.length) {
      form.innerHTML = `<p style="color:red;">No employee list found for this job. Generate the link from the tool first so it can save the names.</p>`;
      document.getElementById('submitRatings').disabled = true;
      throw new Error('Missing employees');
    }

    // Build the form UI
    saved.forEach((name, index) => {
      const fieldset = document.createElement('fieldset');
      fieldset.innerHTML = `
        <legend class="employee-rating">
          <span class="employee-name">${name}</span>
          <div class="stars">
            ${[1,2,3,4,5].map(i => `
              <input type="radio" id="star${i}-${index}" name="rating-${index}" value="${i}">
              <label for="star${i}-${index}" title="${i} star">â˜…</label>
            `).reverse().join('')}
          </div>
        </legend>

        <div class="feedback-section" id="feedback-${index}" style="display:none;">
          <label for="comment-${index}">Please explain the rating:</label>
          <textarea id="comment-${index}" name="comment-${index}" rows="3"></textarea>
        </div>

        <div class="rehire-section" id="rehire-${index}" style="display:none;">
          <label for="rehire-${index}">Would you rehire this employee next season?</label>
          <select id="rehire-${index}" name="rehire-${index}">
            <option value="">-- Select --</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>
      `;
      form.appendChild(fieldset);
    });

    // Toggle feedback/rehire visibility based on chosen stars
    form.addEventListener('change', (e) => {
      if (!e.target.matches("input[type='radio']")) return;
      const idx = e.target.name.split('-')[1];
      const val = parseInt(e.target.value, 10);
      document.getElementById(`feedback-${idx}`).style.display = val <= 3 ? 'block' : 'none';
      document.getElementById(`rehire-${idx}`).style.display = val <= 2 ? 'block' : 'none';
    });

    // Submit all ratings to Apps Script (action=rate) as form-encoded posts
    document.getElementById('submitRatings').addEventListener('click', async () => {
      const rows = saved.map((name, index) => {
        const ratingInput = form.querySelector(`[name="rating-${index}"]:checked`);
        const rating = ratingInput ? parseInt(ratingInput.value, 10) : 0;
        const comment = (form.querySelector(`#comment-${index}`) || {}).value || '';
        const rehire = (form.querySelector(`#rehire-${index}`) || {}).value || '';
        return { name, rating, comment, rehire };
      });

      // Basic validation: require a rating for each
      const missing = rows.find(r => !r.rating);
      if (missing) {
        statusEl.textContent = 'Please select a star rating for every employee.';
        statusEl.style.color = '#b00020';
        return;
      }

      // Send each rating. Weâ€™ll merge "rehire" into the comments field for now (backend has one comments column).
      // e.g., "Rehire: Yes | actual comments..."
      const requests = rows.map(r => {
        const commentsCombined = (r.rehire ? `Rehire: ${r.rehire} | ` : '') + r.comment;
        const formBody = new URLSearchParams();
        formBody.set('action', 'rate');
        formBody.set('data', JSON.stringify({
          job_id: jobId,
          employee_name: r.name,
          rating: r.rating,
          comments: commentsCombined
        }));
        return fetch(API_BASE + '?t=' + Date.now(), {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formBody.toString()
        }).then(res => res.json());
      });

      try {
        document.getElementById('submitRatings').disabled = true;
        statusEl.textContent = 'Submittingâ€¦';
        statusEl.style.color = '';

        const results = await Promise.all(requests);
        const failed = results.find(x => !x || !x.ok);
        if (failed) throw new Error(failed.error || 'Submit failed');

        // Optional: also give user a CSV to save locally (keeps your original behavior)
        const csv = 'Employee,Rating,Comment,Rehire\n' + rows
          .map(r => {
            const cells = [r.name, String(r.rating), r.comment.replace(/"/g,'""'), r.rehire];
            return '"' + cells.join('","') + '"';
          }).join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const dl = document.createElement('a');
        dl.href = URL.createObjectURL(blob);
        dl.download = `ratings_${jobId}.csv`;
        document.body.appendChild(dl);
        dl.click();
        document.body.removeChild(dl);

        statusEl.textContent = 'Thanks! Ratings submitted.';
        setTimeout(() => { window.location.href = 'thankyou.html'; }, 800);
      } catch (err) {
        statusEl.textContent = 'Error: ' + (err.message || String(err));
        statusEl.style.color = '#b00020';
        document.getElementById('submitRatings').disabled = false;
      }
    });
  </script>
</body>
</html>
