<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rate Employees</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .employee-rating{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:0.5rem}
    .employee-name{font-weight:bold;font-size:1.1rem;margin-right:1rem}
    .stars{display:inline-flex;flex-direction:row-reverse;justify-content:flex-end;gap:4px}
    .stars input[type="radio"]{display:none}
    .stars label{font-size:1.5rem;color:lightgray;cursor:pointer;transition:color .2s}
    .stars input:checked ~ label,.stars label:hover,.stars label:hover ~ label{color:gold}
    .feedback-section,.rehire-section{margin-top:.75rem}
    fieldset{border:1px solid #ccc;border-radius:6px;padding:.75rem 1rem;margin-bottom:1rem}
    legend{padding:0 .5rem}
    textarea,select{width:100%;padding:.5rem;margin-top:.25rem}
    button{margin-top:1rem}
    .note{color:#666;font-size:.9rem;margin-bottom:.75rem}
  </style>
</head>
<body>
  <div class="container">
    <h1>Rate Each Employee</h1>
    <p class="note">Job: <span id="jobId"></span></p>

    <form id="ratingForm"></form>
    <button type="button" id="submitRatings">Submit Ratings</button>

    <div id="status" class="note" aria-live="polite" style="margin-top:.75rem;"></div>
  </div>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbzGUshQUlejXpdG5PxYv3RUbdQgj1aCLlHAE6e_LHdomaJ6i9slhZUE_ZBCQxvuRh4r/exec'; // <-- replace

    const form = document.getElementById('ratingForm');
    const statusEl = document.getElementById('status');
    const params = new URLSearchParams(location.search);
    // Prefer ?job=ID; fall back to ?client=ClientName_ID and extract the trailing ID after the last underscore
    let jobId = params.get('job') || '';
    if (!jobId) {
      const clientParam = params.get('client') || '';
      if (clientParam && clientParam.indexOf('_') !== -1) {
        jobId = clientParam.split('_').pop();
      }
    }
    document.getElementById('jobId').textContent = jobId || '(missing)';

    // Prefer localStorage list (saved by generator). If missing, we'll still allow manual entry fallback.
    let saved = (localStorage.getItem('last_emps_' + jobId) || '').split('\n').filter(Boolean);

    if (!jobId) {
      form.innerHTML = '<p style="color:red;">Missing job id. Use a link like <code>rate.html?job=10522</code>.</p>';
      document.getElementById('submitRatings').disabled = true;
    } else if (!saved.length) {
      form.innerHTML = '<p class="note">No employee list found for this job on this device. Paste names below (one per line) and submit — we will still record ratings.</p>'+
                       '<textarea id="fallbackNames" rows="6" placeholder="John Smith\nJane Doe"></textarea>';
      // Allow submit; we'll use fallback names.
    } else {
      buildEmployeeBlocks(saved);
    }

    function buildEmployeeBlocks(names){
      names.forEach(function(name, index){
        const fieldset = document.createElement('fieldset');
        fieldset.innerHTML = '
          <legend class="employee-rating">\n\
            <span class="employee-name">'+escapeHtml(name)+'</span>\n\
            <div class="stars">\n\
              '+[1,2,3,4,5].map(function(i){return '\n\
                <input type="radio" id="star'+i+'-'+index+'" name="rating-'+index+'" value="'+i+'">\n\
                <label for="star'+i+'-'+index+'" title="'+i+' star">★</label>\n\
              ';}).reverse().join('')+'\n\
            </div>\n\
          </legend>\n\
          <div class="feedback-section" id="feedback-'+index+'" style="display:none;">\n\
            <label for="comment-'+index+'">Please explain the rating:</label>\n\
            <textarea id="comment-'+index+'" name="comment-'+index+'" rows="3"></textarea>\n\
          </div>\n\
          <div class="rehire-section" id="rehire-'+index+'" style="display:none;">\n\
            <label for="rehire-'+index+'">Would you rehire this employee next season?</label>\n\
            <select id="rehire-'+index+'" name="rehire-'+index+'">\n\
              <option value="">-- Select --</option>\n\
              <option value="Yes">Yes</option>\n\
              <option value="No">No</option>\n\
            </select>\n\
          </div>';
        form.appendChild(fieldset);
      });
    }

    form.addEventListener('change', function(e){
      if (!e.target.matches("input[type='radio']")) return;
      const idx = e.target.name.split('-')[1];
      const val = parseInt(e.target.value, 10);
      document.getElementById('feedback-'+idx).style.display = val <= 3 ? 'block' : 'none';
      document.getElementById('rehire-'+idx).style.display = val <= 2 ? 'block' : 'none';
    });

    document.getElementById('submitRatings').addEventListener('click', async function(){
      let names = saved;
      const fb = document.getElementById('fallbackNames');
      if (!names.length && fb) {
        names = fb.value.split(/\n+/).map(function(s){return s.trim();}).filter(Boolean);
        if (!names.length){
          statusEl.textContent = 'Please paste names or use a generated link with employees.';
          statusEl.style.color = '#b00020';
          return;
        }
        // Build blocks dynamically so rating controls exist
        form.innerHTML = '';
        buildEmployeeBlocks(names);
      }

      const rows = names.map(function(name, index){
        const ratingInput = form.querySelector('[name="rating-'+index+'"]:checked');
        const rating = ratingInput ? parseInt(ratingInput.value, 10) : 0;
        const commentEl = form.querySelector('#comment-'+index);
        const rehireEl = form.querySelector('#rehire-'+index);
        const comment = commentEl ? commentEl.value : '';
        const rehire = rehireEl ? rehireEl.value : '';
        return { name: name, rating: rating, comment: comment, rehire: rehire };
      });

      if (rows.some(function(r){ return !r.rating; })) {
        statusEl.textContent = 'Please select a star rating for every employee.';
        statusEl.style.color = '#b00020';
        return;
      }

      const requests = rows.map(function(r){
        const commentsCombined = (r.rehire ? ('Rehire: '+r.rehire+' | ') : '') + r.comment;
        const body = new URLSearchParams();
        body.set('action', 'rate');
        body.set('data', JSON.stringify({ job_id: jobId, employee_name: r.name, rating: r.rating, comments: commentsCombined }));
        return fetch(API_BASE + '?t=' + Date.now(), { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: body.toString() }).then(function(res){ return res.json(); });
      });

      try {
        document.getElementById('submitRatings').disabled = true;
        statusEl.textContent = 'Submitting…';
        statusEl.style.color = '';
        const results = await Promise.all(requests);
        if (results.some(function(x){ return !x || !x.ok; })) throw new Error('Submit failed');
        statusEl.textContent = 'Thanks! Ratings submitted.';
        setTimeout(function(){ window.location.href = 'thankyou.html'; }, 800);
      } catch (e) {
        statusEl.textContent = 'Error: ' + (e.message || String(e));
        statusEl.style.color = '#b00020';
        document.getElementById('submitRatings').disabled = false;
      }
    });

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, function(c){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]);});
    }
  </script>
</body>
</html>
