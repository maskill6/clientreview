<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin â€” Ratings Viewer</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <h1>Admin â€” Ratings Viewer</h1>

    <label for="job">Job ID</label>
    <input id="job" placeholder="e.g., LO-8484" />

    <label for="token">Admin Token</label>
    <input id="token" placeholder="paste ADMIN_TOKEN" />

    <button id="load">Load</button>

    <div style="margin-top:1rem">
      <strong>Quick links:</strong>
      <div id="links"></div>
    </div>

    <pre id="out" style="white-space:pre-wrap; margin-top:1rem"></pre>
    <button id="csv" style="display:none;">Download CSV</button>
  </div>

  <script>
    // ðŸ”§ REQUIRED: your Apps Script /exec URL
    const API_BASE = 'https://script.google.com/macros/s/PASTE_YOUR_EXEC_URL_HERE/exec';

    // ðŸ”’ Hard-code repo root so we NEVER use the current file name or path
    const repoRoot = 'https://maskill6.github.io/clientreview/';

    const $job = document.getElementById('job');
    const $tok = document.getElementById('token');
    const $out = document.getElementById('out');
    const $csv = document.getElementById('csv');
    const $links = document.getElementById('links');

    // Prefill from URL (?job=..., ?token=...)
    (function initFromURL(){
      const p = new URLSearchParams(location.search);
      if (p.get('job')) $job.value = p.get('job');
      if (p.get('token')) $tok.value = p.get('token');
      renderLinks();
    })();

    document.getElementById('load').addEventListener('click', loadData);
    $job.addEventListener('input', renderLinks);

    async function loadData(){
      const id = $job.value.trim();
      const t = $tok.value.trim();
      if (!id || !t){ alert('Job + token required'); return; }

      const url = API_BASE + '?action=job&id=' + encodeURIComponent(id) + '&token=' + encodeURIComponent(t) + '&t=' + Date.now();
      $out.textContent = 'Loadingâ€¦';
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.error){ throw new Error(data.error); }
        $out.textContent = JSON.stringify(data, null, 2);
        $csv.style.display = 'inline-block';
        $csv.onclick = function(){ downloadCSV(data); };
      } catch(e) {
        $out.textContent = 'Error: ' + (e.message || String(e));
        $csv.style.display = 'none';
      }
    }

    function renderLinks(){
      const id = $job.value.trim();
      if (!id) { $links.innerHTML = '(enter a Job ID to see links)'; return; }
      const rateLink  = repoRoot + 'rate.html?job='  + encodeURIComponent(id);
      const adminLink = repoRoot + 'admin.html?job=' + encodeURIComponent(id);
      $links.innerHTML = `
        <a href="${rateLink}" target="_blank" rel="noopener">Rate page</a><br>
        <a href="${adminLink}" target="_blank" rel="noopener">Admin page</a>
      `;
    }

    function downloadCSV(data){
      const rows = [['Employee','Rating','Comments','SubmittedAt']];
      const ratings = data.ratings || {};
      Object.keys(ratings).forEach(function(name){
        ratings[name].forEach(function(r){
          rows.push([name, r.rating, r.comments || '', r.submitted_at]);
        });
      });
      const csv = rows.map(function(r){
        return '"' + r.map(function(c){ return String(c).replace(/"/g,'""'); }).join('","') + '"';
      }).join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ratings_' + (data.meta && data.meta.id || 'export') + '.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
  </script>
</body>
</html>
